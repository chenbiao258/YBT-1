<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper
	namespace="com.sinosoft.service.business.db.dao.CertifySectionCheckModifyDao">

	<resultMap
		type="com.sinosoft.service.business.ui.certifysection.bean.CertifySectionCheckSelect"
		id="BaseResultMap">
		<id column="id" jdbcType="VARCHAR" property="id" />
		<result column="name" jdbcType="VARCHAR" property="name" />
		<result column="codename" jdbcType="VARCHAR" property="codeName" />
		<result column="certifystart" jdbcType="VARCHAR" property="certifyStart" />
		<result column="certifyend" jdbcType="VARCHAR" property="certifyEnd" />
	</resultMap>

	<!-- 查询待审核单证 -->
	<select id="selectAll" resultMap="BaseResultMap"
		parameterType="String">
		select a.name,
	      c.codename,
	      b.certifystart,
	      b.certifyend,
	      b.id
	    from
	      lacom a, lzcardA b, ldcode c
	      where
	      a.agentcom = b.agentcom
	      and b.certifytype = c.code
	      and c.codetype = 'certifytype'
	      and b.waitstatus = 'W'
	     <!--   and b.Operator != #{userCode}-->
	      <if test="insuranceCompany !=null and insuranceCompany != ''">
	      	and b.agentcom = #{insuranceCompany}
	      </if>

	</select>


	<!-- 单证审核提交页面加载数据查询 -->

	<select id="selectById" parameterType="String"
		resultType="com.sinosoft.service.business.ui.certifysection.bean.CertifySectionCheckSelect">
		select 
			a.name,
			c.codename,
			e.codename as certifyStatus,
			b.certifystart,
			b.certifyend,
			b.operator
		from 
			lacom a, lzcardA b, ldcode c,  ldcode e
		where 
			a.agentcom = b.agentcom
			and b.certifytype = c.code
			and c.codetype = 'certifytype'
			and b.certifystatus = e.code
			and e.codetype = 'certifystatus'
			and b.id = #{id}
	</select>

	<!-- 单证号段审核保存模块 -->
	
	
	
	
	<!-- 单证号段审核不通过 -->
	<update id="updateStatus" parameterType="String">
		update LzcardA set WaitStatus = 'M',ModifyStatus='Y' where id = #{id}
	</update>
	
	<!-- 单证号段审核通过 -->
		<!-- 1. 查询保险公司的代号 -->
		<select id="selectAgentCom" resultType="String">
			select agentcom from lacom where name = #{name}
		</select>
		
		<select id="selectAgentName">
			select name from lacom where name = #{agentCom}
		</select>
		
		<select id="selectLzcardA" parameterType="String"
			resultType="com.sinosoft.service.business.ui.certifysection.bean.lzcard">
			select * from LzcardA where id = #{id}
		</select>
		
		<select id="selectLzcard" parameterType="String"
			resultType="com.sinosoft.service.business.ui.certifysection.bean.lzcard">
			select * from Lzcard where id = #{id}
		</select>
		
		<!-- 2. 查询单证号段类型的代号 
		<select id="selectCertiType" resultType="String">
			select Code from ldcode where codetype = 'certifytype' and codeName = #{codeName}
		</select>
		-->
		
		<!-- 3. 查询单证号段状态的代号 -->
		<select id="selectCertiStatus" resultType="String">
			select Code from ldcode where  codetype = 'certifystatus' and codename = #{status}
		</select>
		
		
		<!-- 5.审核通过将数据插入到主表和备份表并且将中间表的数据删除 -->
		
			<!-- 1.将数据从主表中删除加入有的话 -->		
			<delete id="deleteMainById" parameterType="String">
				delete from Lzcard where id = #{id}
			</delete>
			
			<!-- 2.将最新数据插入到主表中 -->
			<insert id="insertMainTable">
			
				insert into LZCARD (ID, AGENTCOM, MANAGECOM, 
			      CERTIFYTYPE, CERTIFYCODE, CERTIFYSTATUS, 
			      CERTIFYSTART, CERTIFYEND, OPERATOR, 
			      WAITSTATUS, MODIFYSTATUS, CERTIFYNO, 
			      CERTIFYNUM, MAKEDATE, MAKETIME, 
			      MODIFYDATE, MODIFYTIME, BAK1, 
			      BAK2, BAK3, BAK4, BAK5, 
			      CERTIFYSTATUSFLAG, CITY, CHECKOPERATOR
			      )
			    values (#{id,jdbcType=VARCHAR}, #{saveData.agentcom,jdbcType=VARCHAR}, #{saveData.managecom,jdbcType=VARCHAR}, 
			      #{saveData.certifytype,jdbcType=VARCHAR}, #{saveData.certifycode,jdbcType=VARCHAR}, #{saveData.certifystatus,jdbcType=VARCHAR}, 
			      #{saveData.certifystart,jdbcType=VARCHAR}, #{saveData.certifyend,jdbcType=VARCHAR}, #{saveData.operator,jdbcType=VARCHAR}, 
			      #{saveData.waitstatus,jdbcType=VARCHAR}, #{saveData.modifystatus,jdbcType=VARCHAR}, #{saveData.certifyno,jdbcType=VARCHAR}, 
			      #{saveData.certifynum,jdbcType=VARCHAR}, #{saveData.makedate,jdbcType=DATE}, #{saveData.maketime,jdbcType=VARCHAR}, 
			      #{saveData.modifydate,jdbcType=DATE}, #{saveData.modifytime,jdbcType=VARCHAR}, #{saveData.bak1,jdbcType=VARCHAR}, 
			      #{saveData.bak2,jdbcType=VARCHAR}, #{saveData.bak3,jdbcType=VARCHAR}, #{saveData.bak4,jdbcType=VARCHAR}, #{saveData.bak5,jdbcType=VARCHAR}, 
			      #{saveData.certifystatusflag,jdbcType=VARCHAR}, #{saveData.city,jdbcType=VARCHAR}, #{saveData.checkoperator,jdbcType=VARCHAR}
			      )
			
			</insert>
			<!--3.将数据插入到备份表中  -->
			<insert id="insertBackupsTable">
			
				insert into LzcardB (ID, AGENTCOM, MANAGECOM, 
			      CERTIFYTYPE, CERTIFYCODE, CERTIFYSTATUS, 
			      CERTIFYSTART, CERTIFYEND, OPERATOR, 
			      WAITSTATUS, MODIFYSTATUS, CERTIFYNO, 
			      CERTIFYNUM, MAKEDATE, MAKETIME, 
			      MODIFYDATE, MODIFYTIME, BAK1, 
			      BAK2, BAK3, BAK4, BAK5, 
			      CERTIFYSTATUSFLAG, CITY, CHECKOPERATOR
			      )
			    values (#{id,jdbcType=VARCHAR}, #{saveData.agentcom,jdbcType=VARCHAR}, #{saveData.managecom,jdbcType=VARCHAR}, 
			      #{saveData.certifytype,jdbcType=VARCHAR}, #{saveData.certifycode,jdbcType=VARCHAR}, #{saveData.certifystatus,jdbcType=VARCHAR}, 
			      #{saveData.certifystart,jdbcType=VARCHAR}, #{saveData.certifyend,jdbcType=VARCHAR}, #{saveData.operator,jdbcType=VARCHAR}, 
			      #{saveData.waitstatus,jdbcType=VARCHAR}, #{saveData.modifystatus,jdbcType=VARCHAR}, #{saveData.certifyno,jdbcType=VARCHAR}, 
			      #{saveData.certifynum,jdbcType=VARCHAR}, #{saveData.makedate,jdbcType=DATE}, #{saveData.maketime,jdbcType=VARCHAR}, 
			      #{saveData.modifydate,jdbcType=DATE}, #{saveData.modifytime,jdbcType=VARCHAR}, #{saveData.bak1,jdbcType=VARCHAR}, 
			      #{saveData.bak2,jdbcType=VARCHAR}, #{saveData.bak3,jdbcType=VARCHAR}, #{saveData.bak4,jdbcType=VARCHAR}, #{saveData.bak5,jdbcType=VARCHAR}, 
			      #{saveData.certifystatusflag,jdbcType=VARCHAR}, #{saveData.city,jdbcType=VARCHAR}, #{saveData.checkoperator,jdbcType=VARCHAR}
			      )
			
			</insert>
			<!-- 4.将中间表的数据删除 -->
			<delete id="deleteBackupsById" parameterType="String">
				delete from LzcardA where id = #{id}
			</delete>
			
			
	<!-- 单证号段修改 -->
	
		<!-- 单证号段修改查询 -->
		<select id="selectAllModify" resultMap="BaseResultMap">
		
			 select 
			 	  a.name,
	              c.codename,
	              b.certifystart,
	              b.certifyend,
	              b.id
	         from lacom a,
	              (select *
	                 from lzcard
	               union
	               select * from lzcarda) b,
	              ldcode c
	        where a.agentcom = b.agentcom
	          and b.certifytype = c.code
	          and c.codetype = 'certifytype'
	          and b.modifystatus = 'Y'
	          <if test="insuranceCompany != null and insuranceCompany != ''">
	          	and b.agentcom = #{insuranceCompany}
	          </if>
		
		</select>
		
		<!-- 单证号段提交页面加载 -->
		
		<select id="selectFromlzcardA" parameterType="String" resultType="String">
			select id from lzcarda where  id = #{id} 
		</select>
		
		<select id="selectFromlzcard" parameterType="String" resultType="String">
			select id from lzcard where  id = #{id} 
		</select>
		
		<select id="loadForm" parameterType="String"
			resultType="com.sinosoft.service.business.ui.certifysection.bean.CertifySectionCheckSelect">
			select
			   a.name,
		       c.codename,
		       b.certifystart,
		       b.certifyend,
		       b.certifyStatus as certifyStatus,
		       b.id as id,
		       b.CERTIFYSTATUSFLAG as certifyStatusFlag
 		  from 
 		  	lacom a, lzcard b, ldcode c
 		where 
 		   a.agentcom = b.agentcom
		   and b.certifytype = c.code
		   and c.codetype = 'certifytype'
		   and b.id = #{id}
		</select>
		
		<select id="loadFormA" parameterType="String"
			resultType="com.sinosoft.service.business.ui.certifysection.bean.CertifySectionCheckSelect">
			select
			   a.name,
			   a.agentcom,
		       c.codename,
		       b.certifystart,
		       b.certifyend,
		       b.certifyStatus as certifyStatus,
		       b.id as id,
		       b.CERTIFYSTATUSFLAG as certifyStatusFlag
 		  from 
 		  	lacom a, lzcardA b, ldcode c 
 		where 
 		   a.agentcom = b.agentcom
		   and b.certifytype = c.code
		   and c.codetype = 'certifytype'
		   and b.id = #{id}
		</select>
		
		
	
		
		<!-- 单证号段修改提交 -->
		
			<!-- 直接修改 -->
			<update id="updateLzcardA" >
					
				update LzcardA set
					AGENTCOM = #{saveData.agentcom,jdbcType=VARCHAR},
					CERTIFYSTATUS = #{saveData.certifystatus,jdbcType=VARCHAR},
					CERTIFYSTART = #{saveData.certifystart,jdbcType=VARCHAR},
					CERTIFYEND = #{saveData.certifyend,jdbcType=VARCHAR},
					OPERATOR = #{saveData.operator,jdbcType=VARCHAR},
					WAITSTATUS = #{saveData.waitstatus,jdbcType=VARCHAR},
					CERTIFYNUM = #{saveData.certifynum,jdbcType=VARCHAR},
					MODIFYSTATUS = #{saveData.modifystatus,jdbcType=VARCHAR},
					MODIFYDATE = #{saveData.modifydate,jdbcType=DATE},
					MODIFYTIME = #{saveData.modifytime,jdbcType=VARCHAR},
					CERTIFYSTATUSFLAG = #{saveData.certifystatusflag,jdbcType=VARCHAR},
					CHECKOPERATOR = #{saveData.checkoperator,jdbcType=VARCHAR}	     
				where ID = #{id,jdbcType=VARCHAR}
					
					
			</update>
		
			<!-- 1.线插入数据到中间表lzcardA等待审核 -->
			<insert id="insertMiddleTable" >
				<!-- saveModifyData 
				insert into LzcardA 
				( ID,AgentCom,ManageCom,CertifyType,
				  CertifyCode,CertifyStatus,CertifyStart,CertifyEnd,
				  Operator,WaitStatus,CertifyNo,
				  CertifyNum,MakeDate,MakeTime,ModifyDate,ModifyTime ) 
				values 
				  ( #{id,jdbcType=VARCHAR},#{saveData.selectedInsCom,jdbcType=VARCHAR},'00',#{saveData.selectedCertiType,jdbcType=VARCHAR},
				  	#{saveData.certifyCode,jdbcType=VARCHAR},#{saveData.selectedCertiStatus,jdbcType=VARCHAR},#{saveData.certifyNumStart,jdbcType=VARCHAR},#{saveData.certifyNumEnd,jdbcType=VARCHAR},
				  	#{saveData.operator,jdbcType=VARCHAR},'W',#{saveData.certifyNumEnd,jdbcType=VARCHAR},
				  	'11',#{saveData.makedate,jdbcType=DATE},#{saveData.maketime,jdbcType=VARCHAR},#{saveData.modifydate,jdbcType=DATE},#{saveData.modifytime,jdbcType=VARCHAR} )
			-->
			
				insert into LzcardA (ID, AGENTCOM, MANAGECOM, 
			      CERTIFYTYPE, CERTIFYCODE, CERTIFYSTATUS, 
			      CERTIFYSTART, CERTIFYEND, OPERATOR, 
			      WAITSTATUS, MODIFYSTATUS, CERTIFYNO, 
			      CERTIFYNUM, MAKEDATE, MAKETIME, 
			      MODIFYDATE, MODIFYTIME, BAK1, 
			      BAK2, BAK3, BAK4, BAK5, 
			      CERTIFYSTATUSFLAG, CITY, CHECKOPERATOR
			      )
			    values (#{id,jdbcType=VARCHAR}, #{saveData.agentcom,jdbcType=VARCHAR}, #{saveData.managecom,jdbcType=VARCHAR}, 
			      #{saveData.certifytype,jdbcType=VARCHAR}, #{saveData.certifycode,jdbcType=VARCHAR}, #{saveData.certifystatus,jdbcType=VARCHAR}, 
			      #{saveData.certifystart,jdbcType=VARCHAR}, #{saveData.certifyend,jdbcType=VARCHAR}, #{saveData.operator,jdbcType=VARCHAR}, 
			      #{saveData.waitstatus,jdbcType=VARCHAR}, #{saveData.modifystatus,jdbcType=VARCHAR}, #{saveData.certifyno,jdbcType=VARCHAR}, 
			      #{saveData.certifynum,jdbcType=VARCHAR}, #{saveData.makedate,jdbcType=DATE}, #{saveData.maketime,jdbcType=VARCHAR}, 
			      #{saveData.modifydate,jdbcType=DATE}, #{saveData.modifytime,jdbcType=VARCHAR}, #{saveData.bak1,jdbcType=VARCHAR}, 
			      #{saveData.bak2,jdbcType=VARCHAR}, #{saveData.bak3,jdbcType=VARCHAR}, #{saveData.bak4,jdbcType=VARCHAR}, #{saveData.bak5,jdbcType=VARCHAR}, 
			      #{saveData.certifystatusflag,jdbcType=VARCHAR}, #{saveData.city,jdbcType=VARCHAR}, #{saveData.checkoperator,jdbcType=VARCHAR}
			      )
			 </insert>
			<!-- 2.更新主表的数据使其能用 -->
			<update id="updateModifyStatus" parameterType="String">
				update Lzcard set ModifyStatus='N' where id = #{id}
			</update>
</mapper>











